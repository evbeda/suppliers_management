{% extends 'base.html' %}
{% load i18n %}

{% block content %}
{% include 'AP_app/navbar.html' %}
{{ block.super }}
{% csrf_token %}

<div class="row m-2">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header">
        Invoice #
        <strong>{{invoice.invoice_number}}</strong>
        Date
        <strong>{{invoice.invoice_date}}</strong>
        {% if invoice.status == INVOICE_STATUS_CHANGES_REQUEST and is_AP %}
        <span><a href="{% url 'invoice-update' pk=invoice.id %}" title="Edit Invoice" class="fa fa-edit"></a></span>
        {% endif %}
        {% if invoice.status == INVOICE_STATUS_CHANGES_REQUEST and not is_AP %}
        <span><a href="{% url 'taxpayer-invoice-update' taxpayer_id=taxpayer.id pk=invoice.id %}" class="fa fa-edit">Edit
            info</a></span>
        {% endif %}
        <span class="float-right">
          <strong>Status:</strong>
          {% if invoice.status == INVOICE_STATUS_NEW %}
              <span class="badge badge-primary">{{invoice.get_status_display}}</span>
              {% endif %}
              {% if invoice.status == INVOICE_STATUS_REJECTED %}
              <span class="badge badge-danger">{{invoice.get_status_display}}</span>
              {% endif %}
              {% if invoice.status == INVOICE_STATUS_CHANGES_REQUEST %}
              <span class="badge badge-warning">{{invoice.get_status_display}}</span>
              {% endif %}
              {% if invoice.status == INVOICE_STATUS_PAID %}
              <span class="badge badge-dark">{{invoice.get_status_display}}</span>
              {% endif %}
              {% if invoice.status == INVOICE_STATUS_APPROVED %}
              <span class="badge badge-success">{{invoice.get_status_display}}</span>
              {% endif %}
      </div>
      <div class="card-body">
        <div class="row mb-4">
          <div class="col-sm-4">
            <h6 class="mb-3">From:</h6>
            <div>
              <strong>{{taxpayer.razon_social}}</strong>
            </div>
            <div>{{address.street}} {{address.number}}</div>
            <div>{{address.zip_code}} {{address.city}}</div>
            <div>{{address.country}}</div>
          </div>
          <div class="col-sm-4">
            <h6 class="mb-3">Details:</h6>
            <div><strong>CUIT:</strong> {{taxpayer.cuit}}</div>
            <div><strong>Payment option:</strong> {{taxpayer.forma_de_pago}}</div>
            <div><strong>PO Number:</strong> {{invoice.po_number}}</div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-4 col-sm-5 ml-auto">
            <table class="table table-clear">
              <tbody>
                <tr>
                  <td class="left">
                    <strong>Net Amount: </strong>
                  </td>
                  <td class="right">
                    <strong>{{invoice.currency}}</strong> {{invoice.net_amount}}
                  </td>
                </tr>
                <tr>
                  <td class="left">
                    <strong>VAT</strong>
                  </td>
                  <td class="right">
                    <strong>{{invoice.currency}}</strong> {{invoice.vat}}
                  </td>
                </tr>
                <tr>
                  <td class="left">
                    <strong>Total</strong>
                  </td>
                  <td class="right">
                    <strong>{{invoice.currency}}</strong> {{invoice.total_amount}}
                  </td>
                </tr>
              </tbody>
            </table>

          </div>
        </div>
      </div>
      {% if is_AP %}
      <div class="card-footer">
        <form method='POST' class="form-inline" action='{% url 'change-invoice-status' pk=invoice.id %}' enctype="multipart/form-data">
          {% csrf_token %}
          <button type="submit" name='status' class="btn btn-success" value="{{ INVOICE_STATUS_APPROVED }}">Approve</button>
          <button type="submit" name='status' class="ml-2 btn btn-warning" value="{{ INVOICE_STATUS_CHANGES_REQUEST }}">Request Changes</button>
          <button type="submit" name='status' class="ml-2 btn btn-danger" value="{{ INVOICE_STATUS_REJECTED }}">Reject</button>
        </form>
        <span><a href="{% url 'invoice-history' pk=invoice.id %}" class="btn btn-primary float-right">History</a></span>
      </div>
      {% endif %}
    </div>
  </div>
  <div class="col-md-4">
    <iframe src="http://docs.google.com/gview?url={{ invoice.invoice_file.url }}&embedded=true" style="width:100%; height:100%;" frameborder="0"></iframe>
    <div class="row">
      <div class="col text-center">
        <a href="{{ invoice.invoice_file.url }}" class="fa fa-download fa-2x"></a>
      </div>
    </div>

  </div>
  <div class="col-md-12 text-center mt-4">
    {% if invoice.po_file %}
    <span><a href="http://docs.google.com/gview?url={{ invoice.po_file.url }}" class="btn btn-info" target="_blank">View
        PO</a></span>
    {% endif %}

  </div>
  <div class="col-md-8">
    <div class="card my-3 p-3 bg-white rounded shadow-sm">
      <h6 class="border-bottom border-gray pb-2 mb-0">Recent updates</h6>
      <div>
        {% for comment in comments %}
        <div class="row text-muted media-body pt-3 ml-1 mr-1 mb-0 small lh-125 border-bottom border-gray">
          <div class="col">
            <p>
              <strong class="d-block text-gray-dark">{{ comment.comment_date_received }}</strong>
              {{ comment.message }}
            </p>
          </div>
        </div>
        {% endfor %}
        <div class="container">
          <div class="row mt-2">
            <div class="col">
              <h6>Make a comment</h6>
              <form method='POST' action='{% url 'post-comment' pk=invoice.id %}' enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-group">
                  <textarea class="form-control" name="message" rows="3"></textarea>
                </div>
                <button type="submit" name='status' class="btn btn-success">Post a comment</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
